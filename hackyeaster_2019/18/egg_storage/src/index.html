<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Egg Storage</title>
        <link href="main.css" rel="stylesheet" type="text/css"/>
    </head>

    <body>
        <main>
            <h1>Egg Storage</h1>
            <form id="egg">
                <input id="pass" type="text" minlength="24" maxlength="24" required>
                <button>Validate</button>
            </form>
            <img id="result" src="images/flag_gray.png">
        </main>
    </body>

    <script>
        document.getElementById('egg').addEventListener('submit', (e) => {
            e.preventDefault();

            const password = document.getElementById('pass').value.split('').map(e => e.charCodeAt(0));
            const content = new Uint8Array([0,97,115,109,1,0,0,0,1,42,4,96,1,127,1,127,96,24,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,1,127,96,0,1,127,96,0,1,127,2,18,1,4,98,97,115,101,9,102,117,110,99,116,105,111,110,115,0,3,3,4,3,0,1,2,5,4,1,1,1,1,7,50,4,13,118,97,108,105,100,97,116,101,82,97,110,103,101,0,1,16,118,97,108,105,100,97,116,101,80,97,115,115,119,111,114,100,0,2,7,100,101,99,114,121,112,116,0,3,1,48,2,0,10,153,5,3,89,0,65,48,32,0,70,65,49,32,0,70,114,65,51,32,0,70,114,65,52,32,0,70,114,65,53,32,0,70,114,65,200,0,32,0,70,114,65,204,0,32,0,70,114,65,216,0,32,0,70,114,65,227,0,32,0,70,114,65,228,0,32,0,70,114,65,230,0,32,0,70,114,65,242,0,32,0,70,114,4,64,65,1,15,11,65,0,15,11,143,4,1,3,127,16,0,26,65,24,32,0,58,0,0,65,24,32,1,58,0,1,65,24,32,2,58,0,2,65,24,32,3,58,0,3,65,24,32,4,58,0,4,65,24,32,5,58,0,5,65,24,32,6,58,0,6,65,24,32,7,58,0,7,65,24,32,8,58,0,8,65,24,32,9,58,0,9,65,24,32,10,58,0,10,65,24,32,11,58,0,11,65,24,32,12,58,0,12,65,24,32,13,58,0,13,65,24,32,14,58,0,14,65,24,32,15,58,0,15,65,24,32,16,58,0,16,65,24,32,17,58,0,17,65,24,32,18,58,0,18,65,24,32,19,58,0,19,65,24,32,20,58,0,20,65,24,32,21,58,0,21,65,24,32,22,58,0,22,65,24,32,23,58,0,23,65,4,33,24,3,64,65,24,32,24,106,45,0,0,16,1,69,4,64,65,0,15,11,32,24,65,1,106,33,24,32,24,65,23,76,13,0,11,32,0,65,212,0,71,4,64,65,0,15,11,32,1,65,232,0,71,4,64,65,0,15,11,32,2,65,51,71,4,64,65,0,15,11,32,3,65,208,0,71,4,64,65,0,15,11,32,23,32,17,71,4,64,65,0,15,11,32,12,32,16,71,4,64,65,0,15,11,32,22,32,15,71,4,64,65,0,15,11,32,5,32,7,107,65,14,71,4,64,65,0,15,11,32,14,65,1,106,32,15,71,4,64,65,0,15,11,32,9,32,8,111,65,40,71,4,64,65,0,15,11,32,5,32,9,107,32,19,106,65,207,0,71,4,64,65,0,15,11,32,7,32,14,107,32,20,71,4,64,65,0,15,11,32,9,32,4,111,65,2,108,32,13,71,4,64,65,0,15,11,32,13,32,6,111,65,20,71,4,64,65,0,15,11,32,11,32,13,111,32,21,65,46,107,71,4,64,65,0,15,11,32,7,32,6,111,32,10,71,4,64,65,0,15,11,32,23,32,22,111,65,2,71,4,64,65,0,15,11,65,4,33,24,65,0,33,25,65,0,33,26,3,64,32,25,65,24,32,24,106,45,0,0,106,33,25,32,26,65,24,32,24,106,45,0,0,115,33,26,32,24,65,1,106,33,24,32,24,65,24,76,13,0,11,32,25,65,200,10,71,4,64,65,0,15,11,32,26,65,44,71,4,64,65,0,15,11,16,3,26,65,1,15,11,44,1,1,127,3,64,32,0,32,0,45,0,0,65,24,32,0,106,45,0,0,115,58,0,0,32,0,65,1,106,33,0,32,0,65,24,76,13,0,11,65,185,10,15,11,11,30,1,0,65,0,11,24,102,81,1,105,80,19,87,80,3,106,6,7,7,123,5,4,80,11,6,7,87,122,80,4]);

            function setResultImage(image) {
                const result = document.getElementById('result');
                result.setAttribute('src', `images/${image}.png`);
            }

            function showError() {
                setResultImage('flag_error');
                setTimeout(() => setResultImage('flag_gray'), 1000);
            }

            function getEgg(instance) {
                const memory = new Uint8Array(instance.exports['0'].buffer);
                let flag = '';

                for (let i = 0; i < 24; i++) {
                    flag += String.fromCharCode(memory[i]);
                }

                return flag;
            }

            function callWasm(instance) {
                if (instance.exports.validatePassword(...password)) {
                    setResultImage(`eggs/${getEgg(instance)}`);
                } else {
                    showError();
                }
            }

            function nope() {
                for (let i = 0; i < 100; i++) {
                    debugger;
                }

                return 1337;
            }

            function compileAndRun() {
                WebAssembly.instantiate(content, {
                    base: {
                        functions: nope
                    }
                }).then(module => callWasm(module.instance));
            }

            compileAndRun();

            return false;
        });
    </script>
</html>
